/*
 * bowl.js v0.1.4
 * (c) 2016-2017 classicemi
 * Released under the MIT license.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Bowl=t()}(this,function(){"use strict";function e(e){return"[object Object]"===Object.prototype.toString.call(e)}function t(e){return"[object String]"===Object.prototype.toString.call(e)}function n(e){return"[object Array]"===Object.prototype.toString.call(e)}function r(e){return/^(https?|\/\/)/.test(e)}function i(t){var r=null;if(e(t)){r={};for(var o in t)e(t[o])||n(t[o])?r[o]=i(t[o]):r[o]=t[o]}else n(t)?(r=[],t.forEach(function(t,o){if(e(t)||n(t))return void(r[o]=i(t));r[o]=t})):r=t;return r}function o(t,n,r){if(void 0===r&&(r=!1),e(t)&&e(n)){var o=i(t);for(var c in n)o.hasOwnProperty(c)?o[c]=r?i(n[c]):o[c]:o[c]=i(n[c]);return o}}function c(e,t){var n,r=/^(https?:\/\/)?([^\/:]+)?:?(\d+)?/,i=e.match(r),o=t.match(r);n=[i[1]?i[1]:"http://",i[2]?i[2]:location.hostname,i[3]?i[3]:"80"],i[1]=n[0],i[2]=n[1],i[3]=n[2],o[3]||(o[2]?o[3]="80":o[3]=i[3]);var c;return c=[o[1]?o[1]:i[1],o[2]?o[2]:i[2]],o[1]=c[0],o[2]=c[1],i[0]=""+i[1]+i[2]+":"+i[3],o[0]=""+o[1]+o[2]+":"+o[3],i[0]!==o[0]}function s(e){return t(e)?JSON.parse(p.getItem(e)):n(e)?e.map(function(e){return JSON.parse(p.getItem(e))}):void 0}function u(t,n){e(n)&&p.setItem(t,JSON.stringify(n))}function a(e){return t(e)?p.removeItem(e):n(e)?e.forEach(function(e){return p.removeItem(e)}):void 0}var f=window,p=f.localStorage,h=function(e){this.key=e.key,this.url=e.url,this.content=e.content,this.expire=e.expire},d=function(e){this.config=e};d.prototype.inject=function(e,t){var n=this;if(e.noCache)return this.normalInject(e);var r=s(e.key),i=e.ext,o=(new Date).getTime(),c=e.expireAfter?(new Date).getTime()+e.expireAfter:null;return c=e.expireWhen?e.expireWhen:c,e.expire=c,r&&e.url===r.url&&(!r.expire||o<r.expire)?new Promise(function(e,n){try{scriptList.push({index:t,ext:i,content:r.content}),e()}catch(e){n(e)}}):new Promise(function(r,o){n.fetchByXHR(e.url).then(function(n){e.content=n.content;var o=new h(e);u(o.key,o),scriptList.push({index:t,ext:i,content:e.content}),r()}).catch(function(e){return o(e)})})},d.prototype.appendToPage=function(e,t){switch(e){case"css":var n=document.createElement("style");n.innerText=t,document.getElementsByTagName("head")[0].appendChild(n);break;case"js":var r=document.createElement("script");r.text=t,r.defer=!0,document.getElementsByTagName("head")[0].appendChild(r)}},d.prototype.normalInject=function(e){var t;switch(e.ext){case"js":t=new Promise(function(t,n){var r=document.createElement("script");r.src=e.url,r.defer=!0,document.getElementsByTagName("body")[0].appendChild(r),r.onload=function(){t()},r.onerror=function(){n()}});break;case"css":t=new Promise(function(t,n){var r=document.createElement("link");r.rel="stylesheet",r.href=e.url,document.getElementsByTagName("head")[0].appendChild(r),r.onload=function(){t()},r.onerror=function(){n()}})}return t},d.prototype.fetchByXHR=function(e){var t=new XMLHttpRequest,n=new Promise(function(n,r){t.open("GET",e),t.onreadystatechange=function(){4===t.readyState&&(200===t.status||0===t.status&&t.responseText?n({content:t.responseText}):r(new Error(t.statusText)))}});return setTimeout(function(){t.readyState<4&&(t.abort(),reject(new Error("\u8bf7\u6c42\u4e2d\u65ad!")))},this.config.timeout),t.send(),n};var l=function(t){this.vertices=e(t)?o({},t):{}};l.prototype.addVertex=function(t){if(!e(this.vertices[t])){var n={name:t,prev:0,next:0,adjList:[]};this.vertices[t]=n}},l.prototype.addEdge=function(e,t){!this.vertices[e]||!this.vertices[t]||this.vertices[e].adjList.indexOf(t)>-1||(++this.vertices[e].next,this.vertices[e].adjList.push(t),++this.vertices[t].prev)},l.prototype.hasCycle=function(){var e=[],t=o({},this.vertices),n=null;for(var r in t)0===t[r].prev&&e.push(t[r]);for(;e.length>0;)n=e.pop(),delete t[n.name],n.adjList.forEach(function(n){0===--t[n].prev&&e.push(t[n])});return Object.keys(t).length>0},l.prototype.getBFS=function(){if(this.hasCycle())throw new Error("There are cycles in resource's dependency relations");for(var e=[],t=new l(this.vertices);Object.keys(t.vertices).length;){var n=[];for(var r in t.vertices)0===t.vertices[r].prev&&n.push(r);n.length&&(e.push(n),n.forEach(function(e){t.vertices[e].adjList.forEach(function(e){--t.vertices[e].prev}),delete t.vertices[e]}))}return e};var v=window,g=v.localStorage&&v.Promise;window.scriptList=[];var y=function(){this.config={timeout:6e4,expireAfter:null,expireWhen:null};var e=[];Object.defineProperty(this,"ingredients",{__proto__:null,configurable:!0,get:function(){return e}}),this.injector=new d(this.config)};return y.prototype.configure=function(e){this.config=o(this.config,e,!0)},y.prototype.add=function(t){var i=this;if(!n(t)){if(!e(t))return;t=[t]}var s=function(e){var t=o(i.config,e,!0),n={},s=((new Date).getTime(),r(t.url)),u=/\.(\w+)(\?.+)?$/i;n.key="bowl-"+(t.key||t.url),n.expireAfter=t.expireAfter,n.expireWhen=t.expireWhen,n.url=s?t.url:v.location.origin+"/"+t.url.replace(new RegExp("^/*"),""),g?(n.noCache=!!t.noCache,c(v.location.origin,n.url)&&(n.noCache=!0)):n.noCache=!0;var a=n.url.match(u);return n.ext=a?a[1]:a,n.dependencies=t.dependencies,n},u=function(e){if(!e.key||!/^[a-zA-z0-9_]+$/.test(e.key))throw new Error("invalid key of bowl ingredient");if(!e.url)throw new Error("no valid url of bowl ingredient");var t=s(e),n=i.ingredients.findIndex(function(e){return e.key===t.key});if(n>-1)return void i.ingredients.splice(n,1,t);i.ingredients.push(t)};t.forEach(function(e){return u(e)})},y.prototype.inject=function(){var e=this,t=this;if(!this.ingredients.length)return Promise.resolve();var n=new l;this.ingredients.forEach(function(e){return n.addVertex(e.key)}),this.ingredients.forEach(function(e){e.dependencies&&e.dependencies.length&&e.dependencies.forEach(function(t){n.addEdge("bowl-"+t,e.key)})});var r=n.getBFS(),i=function(t){var n=[];return t.forEach(function(t,r){n.push(e.injector.inject(e.ingredients.find(function(e){return e.key===t}),r))}),Promise.all(n)},o=Promise.resolve();return r.forEach(function(e){o=o.then(function(){return i(e).then(function(){for(var e=0,n=null;scriptList.length;)n=scriptList.shift(),void 0!==n&&e===n.index?(e++,t.injector.appendToPage(n.ext,n.content)):scriptList.push(n);n=null})})}),o},y.prototype.remove=function(e){var r=this;if(!e){return void this.ingredients.map(function(e){return e.key.replace(new RegExp("^bowl-","i"),"")}).forEach(function(e){return r.remove(e)})}if(t(e)){var i="bowl-"+e,o=this.ingredients.findIndex(function(e){return e.key===i});this.ingredients.splice(o,1),a(i)}else if(n(e)){e.key?e.key:e.url&&e.url;return void e.forEach(function(e){return r.remove(e)})}},y});