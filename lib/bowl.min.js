/*
 * bowl.js v0.0.8
 * (c) 2016-2016 classicemi
 * Released under the MIT license.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Bowl=t()}(this,function(){"use strict";function e(e){return"[object Object]"===Object.prototype.toString.call(e)}function t(e){return"[object String]"===Object.prototype.toString.call(e)}function n(e){return"[object Array]"===Object.prototype.toString.call(e)}function r(e){return/^(https?|\/\/)/.test(e)}function i(t){var r=null;if(e(t)){r={};for(var o in t)e(t[o])||n(t[o])?r[o]=i(t[o]):r[o]=t[o]}else n(t)?(r=[],t.forEach(function(t,o){return e(t)||n(t)?void(r[o]=i(t)):void(r[o]=t)})):r=t;return r}function o(t,n,r){if(void 0===r&&(r=!1),e(t)&&e(n)){var o=i(t);for(var u in n)o.hasOwnProperty(u)?o[u]=r?i(n[u]):o[u]:o[u]=i(n[u]);return o}}var u=window,c="bowl-",a=function(){this.config={timeout:6e4,expireAfter:100,expireWhen:null},this.ingredients=[]};return a.prototype.configure=function(e){this.config=o(this.config,e,!0)},a.prototype.add=function(t){function i(e){var t={},n=(new Date).getTime(),i=r(e.url);return t.key=""+c+(e.key||e.url),t.expireAfter=n+3600*(e.expireAfter?e.expireAfter:100)*1e3,t.expireWhen=e.expireWhen?e.expireWhen:null,t.url=i?e.url:u.location.origin+"/"+e.url.replace(new RegExp("^/*"),""),t}var o=this;if(!n(t)){if(!e(t))return;t=[t]}var a=this,f=function(e){if(e.url){var t=i(e),n=o.ingredients.findIndex(function(e){return e.key===t.key});return n>-1?void o.ingredients.splice(n,1,t):void a.ingredients.push(t)}};t.forEach(function(e){return f(e)})},a.prototype.normalInject=function(e){var t=document.createElement("script");t.src=e,document.body.appendChild(t)},a.prototype.appendScript=function(e){var t=document.createElement("script");t.defer=!0,t.text=e,document.getElementsByTagName("head")[0].appendChild(t)},a.prototype.inject=function(){var e=this;if(!this.ingredients.length)return!1;var t=this,n=[];if(!u.localStorage||!u.Promise)return void this.ingredients.forEach(function(t){e.normalInject(t.url)});var r=function(e){var n=new XMLHttpRequest,r=new Promise(function(t,r){n.open("GET",e),n.onreadystatechange=function(){4===n.readyState&&(200===n.status||0===n.status&&n.responseText?t({content:n.responseText}):r(new Error(n.statusText)))}});return setTimeout(function(){n.readyState<4&&n.abort()},t.config.timeout),n.send(),r};return this.ingredients.forEach(function(t){n.push(new Promise(function(n,i){if(t.noCache)return e.normalInject(t.url),void n();var o=JSON.parse(localStorage.getItem(t.key));o.url===t.url?(e.appendScript(o.content),n()):r(t.url).then(function(r){t.content=r.content,e.appendScript(r.content),localStorage.setItem(t.key,JSON.stringify(t)),n()})}))}),Promise.all(n)},a.prototype.remove=function(n){var r=this;if(!n){var i=this.ingredients.map(function(e){return e.key});return i.forEach(function(e){return r._removeStorage(e)}),void(this.ingredients=[])}var o=null;t(n)?o=""+c+n:e(n)&&(o=""+c+(n.key?n.key:n.url?n.url:""));var u=this.ingredients.findIndex(function(e){return e.key===o});this.ingredients.splice(u,1),localStorage.removeItem(o)},a.prototype._removeStorage=function(e){localStorage.removeItem(e)},a});